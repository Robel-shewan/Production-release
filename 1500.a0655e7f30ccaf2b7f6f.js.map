{"version":3,"file":"1500.a0655e7f30ccaf2b7f6f.js","mappings":"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","sources":["webpack://mattermost-webapp/./src/components/pdf_preview.tsx"],"sourcesContent":["// Copyright (c) 2015-present Mattermost, Inc. All Rights Reserved.\n// See LICENSE.txt for license information.\n\nimport debounce from 'lodash/debounce';\nimport type {PDFDocumentProxy, PDFPageProxy} from 'pdfjs-dist';\nimport type {RenderParameters} from 'pdfjs-dist/types/src/display/api';\nimport React from 'react';\n\nimport type {FileInfo} from '@mattermost/types/files';\n\nimport {getFileDownloadUrl} from 'mattermost-redux/utils/file_utils';\n\nimport FileInfoPreview from 'components/file_info_preview';\nimport LoadingSpinner from 'components/widgets/loading/loading_spinner';\n\nimport {getSiteURL} from 'utils/url';\n\nconst INITIAL_RENDERED_PAGES = 3;\n\nexport type Props = {\n\n    /**\n        * Compare file types\n    */\n    fileInfo: FileInfo;\n\n    /**\n        *  URL of pdf file to output and compare to update props url\n    */\n    fileUrl: string;\n    scale: number;\n    handleBgClose: (e: React.MouseEvent<Element, MouseEvent>) => void;\n}\n\ntype State = {\n    pdf: PDFDocumentProxy | null;\n    pdfPages: Record<number, PDFPageProxy>;\n    pdfPagesLoaded: Record<number, boolean>;\n    numPages: number;\n    loading: boolean;\n    success: boolean;\n    prevFileUrl: string;\n}\n\nexport default class PDFPreview extends React.PureComponent<Props, State> {\n    public pdfPagesRendered: Record<number, boolean>;\n    public container: React.RefObject<HTMLDivElement>;\n    public parentNode: HTMLElement|null = null;\n    public pdfCanvasRef: {[key: string]: React.RefObject<HTMLCanvasElement>} = {};\n\n    constructor(props: Props) {\n        super(props);\n\n        this.pdfPagesRendered = {};\n        this.container = React.createRef();\n\n        this.state = {\n            pdf: null,\n            pdfPages: [],\n            pdfPagesLoaded: {},\n            numPages: 0,\n            loading: true,\n            success: false,\n            prevFileUrl: '',\n        };\n    }\n\n    componentDidMount() {\n        this.getPdfDocument();\n        if (this.container.current) {\n            this.parentNode = this.container.current.parentElement;\n            this.parentNode?.addEventListener('scroll', this.handleScroll);\n        }\n    }\n\n    componentWillUnmount() {\n        if (this.parentNode) {\n            this.parentNode.removeEventListener('scroll', this.handleScroll);\n        }\n    }\n\n    static getDerivedStateFromProps(props: Props, state: State) {\n        if (props.fileUrl !== state.prevFileUrl) {\n            return {\n                pdf: null,\n                pdfPages: {},\n                pdfPagesLoaded: {},\n                numPages: 0,\n                loading: true,\n                success: false,\n                prevFileUrl: props.fileUrl,\n            };\n        }\n        return null;\n    }\n\n    componentDidUpdate(prevProps: Props, prevState: State) {\n        if (this.props.fileUrl !== prevProps.fileUrl) {\n            this.getPdfDocument();\n            this.pdfPagesRendered = {};\n        }\n        if (this.props.scale !== prevProps.scale) {\n            this.pdfPagesRendered = {};\n            if (this.state.success) {\n                for (let i = 0; i < this.state.numPages; i++) {\n                    this.renderPDFPage(i);\n                }\n            }\n        }\n\n        if (!prevState.success && this.state.success) {\n            for (let i = 0; i < this.state.numPages; i++) {\n                this.renderPDFPage(i);\n            }\n        }\n    }\n\n    downloadFile = (e: React.FormEvent) => {\n        const fileDownloadUrl = this.props.fileInfo.link || getFileDownloadUrl(this.props.fileInfo.id);\n        e.preventDefault();\n        window.location.href = fileDownloadUrl;\n    };\n\n    isInViewport = (page: Element) => {\n        const bounding = page.getBoundingClientRect();\n        const viewportTop = this.container.current?.scrollTop ?? 0;\n        const viewportBottom = viewportTop + (this.parentNode?.clientHeight ?? 0);\n        return (\n            (bounding.top >= viewportTop && bounding.top <= viewportBottom) ||\n            (bounding.bottom >= viewportTop && bounding.bottom <= viewportBottom) ||\n            (bounding.top <= viewportTop && bounding.bottom >= viewportBottom)\n        );\n    };\n\n    renderPDFPage = async (pageIndex: number) => {\n        const canvas = this.pdfCanvasRef[`pdfCanvasRef-${pageIndex}`].current;\n        if (!canvas) {\n            // Refs are undefined when testing\n            return;\n        }\n\n        // Always render the first INITIAL_RENDERED_PAGES pages to avoid\n        // problems detecting isInViewport during the open animation\n        if (pageIndex >= INITIAL_RENDERED_PAGES && !this.isInViewport(canvas)) {\n            return;\n        }\n\n        if (this.pdfPagesRendered[pageIndex]) {\n            return;\n        }\n\n        const page = await this.loadPage(this.state.pdf!, pageIndex);\n        const context = canvas.getContext('2d');\n        const viewport = page.getViewport({scale: this.props.scale});\n        canvas.height = viewport.height;\n        canvas.width = viewport.width;\n\n        const renderContext = {\n            canvasContext: context as object,\n            viewport,\n        } as RenderParameters;\n\n        await page.render(renderContext).promise;\n        this.pdfPagesRendered[pageIndex] = true;\n    };\n\n    getPdfDocument = async () => {\n        try {\n            const PDFJS = await import('pdfjs-dist');\n            const worker = await import('pdfjs-dist/build/pdf.worker.entry.js');\n            PDFJS.GlobalWorkerOptions.workerSrc = worker;\n\n            const pdf = await PDFJS.getDocument({\n                url: this.props.fileUrl,\n                cMapUrl: getSiteURL() + '/static/cmaps/',\n                cMapPacked: true,\n            }).promise;\n            this.onDocumentLoad(pdf);\n        } catch (err) {\n            this.onDocumentLoadError(err);\n        }\n    };\n\n    onDocumentLoad = (pdf: PDFDocumentProxy) => {\n        this.setState({pdf, numPages: pdf.numPages});\n        for (let i = 0; i < pdf.numPages; i++) {\n            this.pdfCanvasRef[`pdfCanvasRef-${i}`] = React.createRef();\n        }\n        this.setState({loading: false, success: true});\n    };\n\n    onDocumentLoadError = (reason: string) => {\n        console.log('Unable to load PDF preview: ' + reason); //eslint-disable-line no-console\n        this.setState({loading: false, success: false});\n    };\n\n    loadPage = async (pdf: PDFDocumentProxy, pageIndex: number) => {\n        if (this.state.pdfPagesLoaded[pageIndex]) {\n            return this.state.pdfPages[pageIndex];\n        }\n\n        const page = await pdf.getPage(pageIndex + 1);\n\n        const pdfPages = Object.assign({}, this.state.pdfPages);\n        pdfPages[pageIndex] = page;\n\n        const pdfPagesLoaded = Object.assign({}, this.state.pdfPagesLoaded);\n        pdfPagesLoaded[pageIndex] = true;\n        this.setState({pdfPages, pdfPagesLoaded});\n\n        return page;\n    };\n\n    handleScroll = debounce(() => {\n        if (this.state.success) {\n            for (let i = 0; i < this.state.numPages; i++) {\n                this.renderPDFPage(i);\n            }\n        }\n    }, 100);\n\n    render() {\n        if (this.state.loading) {\n            return (\n                <div\n                    ref={this.container}\n                    className='view-image__loading'\n                >\n                    <LoadingSpinner/>\n                </div>\n            );\n        }\n\n        if (!this.state.success) {\n            return (\n                <FileInfoPreview\n                    fileInfo={this.props.fileInfo}\n                    fileUrl={this.props.fileUrl}\n                />\n            );\n        }\n\n        const pdfCanvases = [];\n        for (let i = 0; i < this.state.numPages; i++) {\n            pdfCanvases.push(\n                <canvas\n                    ref={this.pdfCanvasRef[`pdfCanvasRef-${i}`]}\n                    key={'previewpdfcanvas' + i}\n                />,\n            );\n\n            if (i < this.state.numPages - 1 && this.state.numPages > 1) {\n                pdfCanvases.push(\n                    <div\n                        key={'previewpdfspacer' + i}\n                        className='pdf-preview-spacer'\n                    />,\n                );\n            }\n        }\n\n        return (\n            <div\n                ref={this.container}\n                className='post-code'\n                onClick={this.props.handleBgClose}\n            >\n                {pdfCanvases}\n            </div>\n        );\n    }\n}\n"],"names":["PDFPreview","React","constructor","props","super","_defineProperty","e","fileDownloadUrl","this","fileInfo","link","getFileDownloadUrl","id","preventDefault","window","location","href","page","_this$container$curre","_this$container$curre2","_this$parentNode$clie","_this$parentNode","bounding","getBoundingClientRect","viewportTop","container","current","scrollTop","viewportBottom","parentNode","clientHeight","top","bottom","async","canvas","pdfCanvasRef","concat","pageIndex","isInViewport","pdfPagesRendered","loadPage","state","pdf","context","getContext","viewport","getViewport","scale","height","width","renderContext","canvasContext","render","promise","PDFJS","worker","GlobalWorkerOptions","workerSrc","getDocument","url","fileUrl","cMapUrl","getSiteURL","cMapPacked","onDocumentLoad","err","onDocumentLoadError","setState","numPages","i","loading","success","reason","console","log","pdfPagesLoaded","pdfPages","getPage","Object","assign","debounce","renderPDFPage","prevFileUrl","componentDidMount","_this$parentNode2","getPdfDocument","parentElement","addEventListener","handleScroll","componentWillUnmount","removeEventListener","getDerivedStateFromProps","componentDidUpdate","prevProps","prevState","ref","className","LoadingSpinner","FileInfoPreview","pdfCanvases","push","key","onClick","handleBgClose","_pt"],"sourceRoot":""}